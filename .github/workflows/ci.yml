name: Laravel Sail CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        options: >-
          --health-cmd="mysqladmin ping -proot"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy .env
        run: cp .env.example .env

      - name: Update ENV for CI
        run: |
          echo "DB_CONNECTION=mysql" >> .env
          echo "DB_HOST=127.0.0.1" >> .env
          echo "DB_PORT=3306" >> .env
          echo "DB_DATABASE=testing" >> .env
          echo "DB_USERNAME=root" >> .env
          echo "DB_PASSWORD=root" >> .env
          echo "REDIS_HOST=127.0.0.1" >> .env
          echo "APP_ENV=testing" >> .env

      - name: Set Sail alias
        run: echo 'alias sail="./vendor/bin/sail"' >> ~/.bashrc

      - name: Install Composer dependencies
        run: composer install --no-progress --no-interaction --prefer-dist

      - name: Start Sail Services
        run: ./vendor/bin/sail up -d
        timeout-minutes: 5

      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL..."
          for i in `seq 1 30`; do
            nc -z 127.0.0.1 3306 && echo "MySQL OK" && break
            echo -n "."
            sleep 2
          done

      - name: Generate App Key
        run: ./vendor/bin/sail artisan key:generate

      - name: Run Migrations
        run: ./vendor/bin/sail artisan migrate --force

      #############################################
      #       STATIC ANALYSIS
      #############################################
      - name: PHPStan (Static Analysis)
        run: ./vendor/bin/sail vendor/bin/phpstan analyse --memory-limit=1G

      #############################################
      #       UNIT TESTS
      #############################################
      - name: Run Unit Tests
        run: ./vendor/bin/sail artisan test --testsuite=Unit

      #############################################
      #       INTEGRATION TESTS
      #############################################
      - name: Run Integration Tests
        run: ./vendor/bin/sail artisan test --testsuite=Feature

      #############################################
      #       SYSTEM / E2E TESTS
      #############################################
      - name: Run System Tests
        run: ./vendor/bin/sail artisan test --testsuite=System

      #############################################
      #       STATUS PRINT
      #############################################
      - name: ALL OK
        if: success()
        run: echo "OK"

      - name: FAILED
        if: failure()
        run: |
          echo "Pipeline Failed!"
          exit 1
