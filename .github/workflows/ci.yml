name: Laravel Sail CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Composer dependencies
        run: composer install --no-progress --no-interaction --prefer-dist
        
      - name: Configure .env for Sail CI
        run: |
          cp .env.example .env
          sed -i '/DB_HOST=/c\DB_HOST=mysql' .env
          sed -i '/REDIS_HOST=/c\REDIS_HOST=redis' .env
          echo "APP_ENV=testing" >> .env
          # Asegúrate de que las credenciales coincidan con las variables de entorno 
          # usadas en tu docker-compose.yml (por ejemplo, DB_USERNAME)

      - name: Start Sail Services (App, DB, Redis)
        run: ./vendor/bin/sail up -d
        timeout-minutes: 5
        
      - name: Wait for services to be healthy
        # Esperar 30 segundos, o hasta que la DB de Sail esté disponible
        run: |
          echo "Waiting for Sail services..."
          sleep 10 # Espera inicial para que Docker inicie
          ./vendor/bin/sail artisan about > /dev/null 2>&1 || sleep 10 # Intenta comando y espera si falla

      - name: Generate App Key and Run Migrations
        run: |
          ./vendor/bin/sail artisan key:generate
          ./vendor/bin/sail artisan migrate --force

      - name: PHPStan (Static Analysis)
        run: docker compose exec -u www-data laravel.test vendor/bin/phpstan analyse --memory-limit=1G

      - name: Run Unit Tests
        run: ./vendor/bin/sail artisan test --testsuite=Unit

      - name: Run Integration Tests
        run: ./vendor/bin/sail artisan test --testsuite=Feature

      - name: Run System Tests
        run: ./vendor/bin/sail artisan test --testsuite=System
        
      - name: Stop Sail Services
        if: always()
        run: ./vendor/bin/sail down

      - name: ALL OK
        if: success()
        run: echo "Pipeline Completed Successfully!"
        
      - name: FAILED
        if: failure()
        run: echo "Pipeline Failed!"